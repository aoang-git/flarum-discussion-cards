(()=>{var t={n:a=>{var s=a&&a.__esModule?()=>a.default:()=>a;return t.d(s,{a:s}),s},d:(a,s)=>{for(var e in s)t.o(s,e)&&!t.o(a,e)&&Object.defineProperty(a,e,{enumerable:!0,get:s[e]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};(()=>{"use strict";const a=flarum.core.compat.app;var s=t.n(a);const e=flarum.core.compat.extend,r=flarum.core.compat["forum/components/DiscussionList"];var i=t.n(r);const o=flarum.core.compat["forum/states/DiscussionListState"];var n=t.n(o);const l=flarum.core.compat["forum/components/IndexPage"];var u=t.n(l);const c=flarum.core.compat["common/components/LoadingIndicator"];var d=t.n(c);const p=flarum.core.compat["common/components/Placeholder"];var g=t.n(p);const f=flarum.core.compat["common/components/Button"];var h=t.n(f);function v(t,a){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,a){return t.__proto__=a,t},v(t,a)}function b(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,v(t,a)}const N=flarum.core.compat["common/Component"];var w=t.n(N);const y=flarum.core.compat["common/helpers/icon"];var C=t.n(y);const I=flarum.core.compat["common/components/Tooltip"];var P=t.n(I);function L(t){if(t.length)return[m(".cardBadges",[t.map((function(t){return[m(P(),{text:t.attrs.label?t.attrs.label[0]:"",position:"right"},m("span.cardBadge.Badge.Badge--"+t.attrs.type,[C()(t.attrs.icon)]))]}))])]}function D(t){if("string"!=typeof t)return!1;var a;t.startsWith("http://")||t.startsWith("https://")||(t="http://"+t);try{a=new URL(t)}catch(t){return!1}var s=a.pathname.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(s)}const T=flarum.core.compat["common/components/Link"];var O=t.n(T);const x=flarum.core.compat["tags/utils/sortTags"];var _=t.n(x);function A(t){if(t)return[_()(t).map((function(t){return[m(O(),{className:"cardTag",style:{backgroundColor:t.color()},href:app.route("tag",{tags:t.slug()})},t.name())]}))]}const R=flarum.core.compat["common/utils/humanTime"];var B=t.n(R);const S=flarum.core.compat["common/helpers/username"];var M=t.n(S);const k=flarum.core.compat["common/components/Dropdown"];var j=t.n(k);const W=flarum.core.compat["forum/utils/DiscussionControls"];var H=t.n(W);const q=flarum.core.compat["common/utils/string"],U=flarum.core.compat["common/helpers/avatar"];var V=t.n(U),z=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){return this.discussion.posts().splice(-10).filter((function(t){return!t.isHidden()&&1!==t.number()&&"comment"===t.contentType()})).sort((function(t,a){return a.createdAt()-t.createdAt()})).map((function(t){return t.user()})).filter((function(t,a,s){return s.indexOf(t)===a})).reverse().splice(-3).map((function(t){return V()(t,{className:"Avatar--mini"})}))},a}(w());function E(t,a){return t.isChild&&!a.isChild?-1:!t.isChild&&a.isChild?1:t.isChild&&a.isChild&&t.parent===a.parent?t.position-a.position:t.isChild&&a.isChild&&t.parent!==a.parent?t.parent-a.parent:!t.position&&a.position?1:t.position&&!a.position?-1:t.position&&a.position?t.position-a.position:t.id-a.id}const J=flarum.core.compat["components/TerminalPost"];var F=t.n(J),$=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){var t,a=this.discussion,s={};for(var e in app.forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");s[r=r.replace(/^./,r.charAt(0).toLowerCase())]=app.forum.data.attributes[e]}var i="flarumite-simple-discussion-views"in flarum.extensions,o=a.data.attributes.hasOwnProperty("views"),n="michaelbelgium-discussion-views"in flarum.extensions,l=a.data.attributes.hasOwnProperty("viewCount"),u=i&&o?a.views():n&&l?a.viewCount():NaN,c=app.forum.data.attributes.hasOwnProperty("blogTags"),d={},p=a.data.relationships.hasOwnProperty("blogMeta"),g={};if(c&&(d.tags=app.forum.attribute("blogTags"),d.defaultImage=app.forum.attribute("blogDefaultImage"),p)){var f=a.store.data.blogMeta[a.data.relationships.blogMeta.data.id];D(f.attribute("featuredImage"))&&(g.featuredImage=f.attribute("featuredImage"))}var h,v="shebaoting-repost"in flarum.extensions,b=a.data.attributes.original_url||null,N=m.route.get().split("?")[0].startsWith("/t/");if(N){var w,y=null==(w=m.route.get().split("/t/")[1])?void 0:w.split("?")[0];h=app.store.all("tags").find((function(t){return t.slug()===y})).data.id;var I=app.store.all("tags").find((function(t){return t.id()===h})),P=I?JSON.parse(I.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},T=I?I.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var x in P.defaultImage=T,c&&1===Number(s.useBlogImages)&&d.tags.includes(h)&&(P.defaultImage=p&&g.featuredImage&&D(g.featuredImage)?g.featuredImage:d.defaultImage),P)s.hasOwnProperty(x)&&P[x]!==s[x]&&null!==P[x]&&(s[x]=P[x])}if("/"===m.route.get().split("?")[0]){var _=a.tags();for(var R in _){var S=_[R].id(),k=_[R].isChild(),W=_[R].data.hasOwnProperty("relationships")&&_[R].parent()?_[R].parent().data.id:null,U=_[R].position(),V=_[R].attribute("walsgitDiscussionCardsTagDefaultImage");c&&1===Number(s.useBlogImages)&&d.tags.includes(S)&&(V=p&&g.featuredImage&&D(g.featuredImage)?g.featuredImage:d.defaultImage);var J={id:S,isChild:k,parent:W,position:U,tagCustomImg:V},$=null;s.allowedTags.includes(S)&&null!==V&&(null===$||E(J,$)<0)&&($={id:S,isChild:k,parent:W,position:U,tagCustomImg:V},s.defaultImage=V)}}var G=1===Number(s.markReadCards)&&a.isRead()&&app.session.user?"read":"",K={};K.className="wrapImg"+(1===Number(s.showAuthor)?" After":"");var Q=function(t,a,s,e){if(void 0===s&&(s=!1),void 0===e&&(e=1),s&&D(a))return a;var r=app.forum.attribute("baseUrl")+"/assets/"+a;if(t){var i=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>|background(?:-image)?:\s*url\(['"]?(.*?)['"]?\)/i.exec(t.contentHtml());return"number"==typeof e&&e>0?i?i[1]||i[2]:a?r:null:"~"===e?i:null}}(a.firstPost(),s.defaultImage,p),X=Q?m("img",{src:Q,className:"previewCardImg",alt:a.title(),loading:"lazy"}):m("div",{className:"imgStub"}),Y=Math.min(null!=(t=a.lastPostNumber())?t:0,(a.lastReadPostNumber()||0)+1),Z=a.unreadCount()?app.translator.trans("walsgit_discussion_cards.forum.unreadReplies",{count:a.unreadCount()}):app.translator.trans("walsgit_discussion_cards.forum.replies",{count:a.replyCount()||"0"});return m("div",{key:a.id(),"data-id":a.id(),"data-tag-id":N?h:null,className:"CardsListItem Card "+G+(a.isHidden()?" Hidden":"")},H().controls(a,this).toArray().length?m(j(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},H().controls(a,this).toArray()):"",m(O(),{href:app.route.discussion(a,Y),className:"cardLink"},1===Number(s.showBadges)?L(a.badges().toArray()):"",m("div",K,(o||l)&&m("[",null,1!==Number(s.showViews)||isNaN(u)?"":m("div",{className:"imageLabel discussionViews"},C()("fas fa-eye",{className:"labelIcon"}),u)),X,1===Number(s.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},M()(a.user())),m("div",{className:"Date"},B()(a.createdAt()))):""),m("div",{className:"cardTags"},A(a.tags())),m("div",{className:"cardTitle"},m("h2",{title:a.title(),className:"title"},1===Number(s.allowRepostLinks)&&v&&b?m("a",{href:b,onclick:function(t){return t.stopPropagation()}},(0,q.truncate)(a.title(),80)):(0,q.truncate)(a.title(),80))),1===Number(s.previewText)&&a.firstPost()?m("div",{className:"previewPost"},c&&1===Number(s.useBlogSummary)&&a.data.relationships.hasOwnProperty("blogMeta")&&""!==a.blogMeta().summary()?(0,q.truncate)(a.blogMeta().summary(),150):(0,q.truncate)(a.firstPost().contentPlain(),150)):"",1===Number(s.showLastPostInfo)&&a.firstPost()?m("div",{className:"terminalPost"},m(F(),{discussion:a,lastPost:a.lastPostNumber()})):"",1===Number(s.showReplies)?m("div",{className:"cardSpacer"},m(O(),{className:"Replies",href:app.route.discussion(a,a.lastPostNumber())},m("div",{className:"Left"},m("div",{className:"Avatars"},m(z,{discussion:a})),m("div",{className:"Repcount"},Z)),m("div",{className:"Arrow"},C()("fas fa-angle-right")))):""))},a}(w());const G=flarum.core.compat["common/utils/abbreviateNumber"];var K=t.n(G),Q=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a)},s.view=function(){var t,a=this.attrs.discussion,s={};for(var e in app.forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");s[r=r.replace(/^./,r.charAt(0).toLowerCase())]=app.forum.data.attributes[e]}var i="flarumite-simple-discussion-views"in flarum.extensions,o=a.data.attributes.hasOwnProperty("views"),n="michaelbelgium-discussion-views"in flarum.extensions,l=a.data.attributes.hasOwnProperty("viewCount"),u=i&&o?a.views():n&&l?a.viewCount():NaN,c=app.forum.data.attributes.hasOwnProperty("blogTags"),d={},p=a.data.relationships.hasOwnProperty("blogMeta"),g={};if(c&&(d.tags=app.forum.attribute("blogTags"),d.defaultImage=app.forum.attribute("blogDefaultImage"),p)){var f=a.store.data.blogMeta[a.data.relationships.blogMeta.data.id];D(f.attribute("featuredImage"))&&(g.featuredImage=f.attribute("featuredImage"))}var h="shebaoting-repost"in flarum.extensions,v=a.data.attributes.original_url||null;if(m.route.get().split("?")[0].startsWith("/t/")){var b,N=null==(b=m.route.get().split("/t/")[1])?void 0:b.split("?")[0],w=app.store.all("tags").find((function(t){return t.slug()===N})).data.id,y=app.store.all("tags").find((function(t){return t.id()===w})),I=y?JSON.parse(y.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},P=y?y.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var T in I.defaultImage=P,c&&1===Number(s.useBlogImages)&&d.tags.includes(w)&&(I.defaultImage=p&&g.featuredImage&&D(g.featuredImage)?g.featuredImage:d.defaultImage),I)s.hasOwnProperty(T)&&I[T]!==s[T]&&null!==I[T]&&(s[T]=I[T])}if("/"===m.route.get().split("?")[0]){var x=a.tags();for(var _ in x){var R=x[_].id(),S=x[_].isChild(),k=x[_].data.hasOwnProperty("relationships")&&x[_].parent()?x[_].parent().data.id:null,W=x[_].position(),U=x[_].attribute("walsgitDiscussionCardsTagDefaultImage");c&&1===Number(s.useBlogImages)&&d.tags.includes(R)&&(U=p&&g.featuredImage&&D(g.featuredImage)?g.featuredImage:d.defaultImage);var V={id:R,isChild:S,parent:k,position:W,tagCustomImg:U},z=null;s.allowedTags.includes(R)&&null!==U&&(null===z||E(V,z)<0)&&(z={id:R,isChild:S,parent:k,position:W,tagCustomImg:U},s.defaultImage=U)}}var J,$=1===Number(s.markReadCards)&&a.isRead()&&app.session.user?"read":"",G=Number(s.maxListImages)||3,Q=a.tags(),X=Q&&Q.length>0?Q[Q.length-1]:null,Y=X?X.color():"#ddd",Z=function(t,a,s,e){void 0===s&&(s=!1),void 0===e&&(e=3);var r=[];if(s&&D(a)&&(r.push(a),1===e))return r;if(!t){if(a&&!s){var i=app.forum.attribute("baseUrl")+"/assets/"+a;r.push(i)}return r}for(var o,n=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>/gi,l=t.contentHtml(),u=s&&r.length>0?1:0;null!==(o=n.exec(l))&&u<e;){var m=o[1];m&&!r.includes(m)&&(r.push(m),u++)}if(0===r.length&&a){var c=app.forum.attribute("baseUrl")+"/assets/"+a;r.push(c)}return r}(a.firstPost(),s.defaultImage,p,G),tt=Z.length>0,at=Math.min(null!=(t=a.lastPostNumber())?t:0,(a.lastReadPostNumber()||0)+1),st=(a.unreadCount()?app.translator.trans("walsgit_discussion_cards.forum.unreadReplies",{count:a.unreadCount()}):app.translator.trans("walsgit_discussion_cards.forum.replies",{count:a.replyCount()||"0"}),a.unreadCount()?a.unreadCount()+"*":a.replyCount());return m("div",{key:a.id(),"data-id":a.id(),className:"CardsListItem List "+$+(a.isHidden()?" Hidden":""),style:"--tag-color: "+Y},H().controls(a,this).toArray().length?m(j(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},H().controls(a,this).toArray()):"",m(O(),{href:app.route.discussion(a,at),className:"cardLink"},m("div",{className:"listCardContent"},m("div",{className:"listCardHeader"},m("div",{className:"listHeaderRow"},1===Number(s.showBadges)&&L(a.badges().toArray()),m("div",{className:"cardTags"},A(a.tags())),m("div",{className:"cardTitle"},m("h2",{title:a.title(),className:"title"},1===Number(s.allowRepostLinks)&&h&&v?m("a",{href:v,onclick:function(t){return t.stopPropagation()}},(0,q.truncate)(a.title(),80)):(0,q.truncate)(a.title(),80)),"phone"!==app.screen()&&1===Number(s.showReplies)&&1===Number(s.showRepliesOnRight)?m("div",{className:"DiscussionListItem-count"},m("span",{"aria-hidden":"true"},K()(st)),m("span",{className:"visually-hidden"},app.translator.trans("core.forum.discussion_list.unread_replies_a11y_label",{count:a.replyCount()}))):""))),1===Number(s.previewText)&&a.firstPost()?m("div",{className:"previewPost"},m.trust((J=c&&1===Number(s.useBlogSummary)&&a.data.relationships.hasOwnProperty("blogMeta")&&""!==a.blogMeta().summary()?(0,q.truncate)(a.blogMeta().summary(),300):(0,q.truncate)(a.firstPost().contentPlain(),300))?J.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(?<!\d)(\d{11})(?!\d)/g,'<span class="hashtag">$1</span>').replace(/#([^\s#<>，。！？、；：""''（）]+)/g,'<span class="hashtag">#$1</span>'):"")):"",tt&&m("div",{className:"listImagesRow"},Z.map((function(t,s){return m("img",{key:s,src:t,className:"listImageThumb",alt:a.title(),loading:"lazy"})}))),1===Number(s.showAuthor)&&m("div",{className:"listCardFooter"},m("div",{className:"listMetaInfo"},m("span",{className:"listAuthor"},M()(a.user())),1===Number(s.showReplies)&&m("span",{className:"listReplies"},C()("fas fa-comment",{className:"listIcon"}),m("span",null,st)),m("span",{className:"listDate"},B()(a.createdAt()))),(o||l)&&1===Number(s.showViews)&&!isNaN(u)&&m("div",{className:"listViews"},C()("fas fa-eye",{className:"listIcon"}),m("span",null,u))),1===Number(s.showLastPostInfo)&&a.firstPost()?m("div",{className:"terminalPost"},m(F(),{discussion:a,lastPost:a.lastPostNumber()})):"")))},a}(w());function X(){var t=document.querySelectorAll(".CardsListItem.Card .cardLink"),a=document.querySelectorAll(".cardGrid .colSpan-2"),s=function(t,a){t&&(t.scrollWidth>a.clientWidth-30?t.classList.add("overflowing"):t.classList.remove("overflowing"))};t.forEach((function(t){var a=t.querySelector(".cardTags");s(a,t)})),a.forEach((function(t){var a=t.querySelector(".flexBox .cardTags");s(a,t)}))}const Y={"walsgit/discussion/cards/components/CardItem":$,"walsgit/discussion/cards/components/ListItem":Q,"walsgit/discussion/cards/components/LastReplies":z,"walsgit/discussion/cards/utils/craftTags":A,"walsgit/discussion/cards/utils/craftBadges":L},Z=flarum.core;s().initializers.add("aoang-git-flarum-discussion-cards",(function(){(0,e.extend)(i().prototype,"oncreate",X),(0,e.extend)(i().prototype,"onupdate",X),(0,e.extend)(n().prototype,"requestParams",(function(t){s().current.matches(u())&&t.include.push(["firstPost","posts","posts.user"])})),(0,e.override)(i().prototype,"view",(function(t){var a={};for(var e in s().forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");r=r.replace(/^./,r.charAt(0).toLowerCase()),a[r]=s().forum.data.attributes[e]}var i,o=this.attrs.state,n=o.getParams();if(o.isInitialLoading()||o.isLoadingNext()?i=m(d(),null):o.hasNext()&&(i=h().component({className:"Button",onclick:o.loadNext.bind(o)},s().translator.trans("core.forum.discussion_list.load_more_button"))),o.isEmpty()){var l=s().translator.trans("core.forum.discussion_list.empty_text");return m("div",{className:"DiscussionList"},m(g(),{text:l}))}var c=null;if(m.route.get().split("?")[0].startsWith("/t/")){c=s().store.all("tags").find((function(t){return t.slug()===n.tags})).data.id;var p=JSON.parse(s().store.all("tags").find((function(t){return t.slug()===n.tags})).data.attributes.walsgitDiscussionCardsTagSettings);for(var f in p)a.hasOwnProperty(f)&&p[f]!==a[f]&&(a[f]=p[f])}return s().current.matches(u())&&(a.allowedTags.length&&a.allowedTags.includes(c)||!n.tags&&1===Number(a.onIndexPage))?m("div",{className:"DiscussionList"+(o.isSearchResults()?" DiscussionList--searchResults":"")},m("div",{class:"DiscussionList-discussions flexCard"},o.getPages().map((function(t,s){return t.items.map((function(t,e){return e<Number(a.primaryCards)&&0===s?m($,{discussion:t}):m(Q,{discussion:t})}))}))),m("div",{className:"DiscussionList-loadMore"},i)):t()}))}),-1),Object.assign(Z.compat,Y)})(),module.exports={}})();
//# sourceMappingURL=forum.js.map