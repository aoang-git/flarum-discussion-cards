(()=>{var t={n:a=>{var s=a&&a.__esModule?()=>a.default:()=>a;return t.d(s,{a:s}),s},d:(a,s)=>{for(var e in s)t.o(s,e)&&!t.o(a,e)&&Object.defineProperty(a,e,{enumerable:!0,get:s[e]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};(()=>{"use strict";const a=flarum.core.compat.app;var s=t.n(a);const e=flarum.core.compat.extend,r=flarum.core.compat["forum/components/DiscussionList"];var i=t.n(r);const o=flarum.core.compat["forum/states/DiscussionListState"];var n=t.n(o);const l=flarum.core.compat["forum/components/IndexPage"];var u=t.n(l);const c=flarum.core.compat["common/components/LoadingIndicator"];var d=t.n(c);const p=flarum.core.compat["common/components/Placeholder"];var g=t.n(p);const f=flarum.core.compat["common/components/Button"];var h=t.n(f);function v(t,a){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,a){return t.__proto__=a,t},v(t,a)}function b(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,v(t,a)}const w=flarum.core.compat["common/Component"];var N=t.n(w);const y=flarum.core.compat["common/helpers/icon"];var C=t.n(y);const I=flarum.core.compat["common/components/Tooltip"];var P=t.n(I);function T(t){if(t.length)return[m(".cardBadges",[t.map((function(t){return[m(P(),{text:t.attrs.label?t.attrs.label[0]:"",position:"right"},m("span.cardBadge.Badge.Badge--"+t.attrs.type,[C()(t.attrs.icon)]))]}))])]}function L(t){if("string"!=typeof t)return!1;var a;t.startsWith("http://")||t.startsWith("https://")||(t="http://"+t);try{a=new URL(t)}catch(t){return!1}var s=a.pathname.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(s)}function D(t){if(!t)return"";var a=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(?<!\d)(\d{11})(?!\d)/g,'<span class="hashtag">$1</span>');return a.replace(/#([^\s#<>，。！？、；：""''（）]+)/g,'<span class="hashtag">#$1</span>')}const O=flarum.core.compat["common/components/Link"];var x=t.n(O);const A=flarum.core.compat["tags/utils/sortTags"];var _=t.n(A);function B(t){if(t)return[_()(t).map((function(t){return[m(x(),{className:"cardTag",style:{backgroundColor:t.color()},href:app.route("tag",{tags:t.slug()})},t.name())]}))]}const R=flarum.core.compat["common/utils/humanTime"];var S=t.n(R);const M=flarum.core.compat["common/helpers/username"];var k=t.n(M);const j=flarum.core.compat["common/components/Dropdown"];var H=t.n(j);const W=flarum.core.compat["forum/utils/DiscussionControls"];var q=t.n(W);const F=flarum.core.compat["common/utils/string"],J=flarum.core.compat["common/helpers/avatar"];var U=t.n(J),V=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){return this.discussion.posts().splice(-10).filter((function(t){return!t.isHidden()&&1!==t.number()&&"comment"===t.contentType()})).sort((function(t,a){return a.createdAt()-t.createdAt()})).map((function(t){return t.user()})).filter((function(t,a,s){return s.indexOf(t)===a})).reverse().splice(-3).map((function(t){return U()(t,{className:"Avatar--mini"})}))},a}(N());function z(t,a){return t.isChild&&!a.isChild?-1:!t.isChild&&a.isChild?1:t.isChild&&a.isChild&&t.parent===a.parent?t.position-a.position:t.isChild&&a.isChild&&t.parent!==a.parent?t.parent-a.parent:!t.position&&a.position?1:t.position&&!a.position?-1:t.position&&a.position?t.position-a.position:t.id-a.id}const E=flarum.core.compat["components/TerminalPost"];var $=t.n(E),G=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){var t,a=this.discussion,s={};for(var e in app.forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");s[r=r.replace(/^./,r.charAt(0).toLowerCase())]=app.forum.data.attributes[e]}var i="flarumite-simple-discussion-views"in flarum.extensions,o=a.data.attributes.hasOwnProperty("views"),n="michaelbelgium-discussion-views"in flarum.extensions,l=a.data.attributes.hasOwnProperty("viewCount"),u=i&&o?a.views():n&&l?a.viewCount():NaN,c=app.forum.data.attributes.hasOwnProperty("blogTags"),d={},p=a.data.relationships.hasOwnProperty("blogMeta"),g={};if(c&&(d.tags=app.forum.attribute("blogTags"),d.defaultImage=app.forum.attribute("blogDefaultImage"),p)){var f=a.store.data.blogMeta[a.data.relationships.blogMeta.data.id];L(f.attribute("featuredImage"))&&(g.featuredImage=f.attribute("featuredImage"))}var h,v="shebaoting-repost"in flarum.extensions,b=a.data.attributes.original_url||null,w=m.route.get().split("?")[0].startsWith("/t/");if(w){var N,y=null==(N=m.route.get().split("/t/")[1])?void 0:N.split("?")[0];h=app.store.all("tags").find((function(t){return t.slug()===y})).data.id;var I=app.store.all("tags").find((function(t){return t.id()===h})),P=I?JSON.parse(I.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},O=I?I.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var A in P.defaultImage=O,c&&1===Number(s.useBlogImages)&&d.tags.includes(h)&&(P.defaultImage=p&&g.featuredImage&&L(g.featuredImage)?g.featuredImage:d.defaultImage),P)s.hasOwnProperty(A)&&P[A]!==s[A]&&null!==P[A]&&(s[A]=P[A])}if("/"===m.route.get().split("?")[0]){var _=a.tags();for(var R in _){var M=_[R].id(),j=_[R].isChild(),W=_[R].data.hasOwnProperty("relationships")&&_[R].parent()?_[R].parent().data.id:null,J=_[R].position(),U=_[R].attribute("walsgitDiscussionCardsTagDefaultImage");c&&1===Number(s.useBlogImages)&&d.tags.includes(M)&&(U=p&&g.featuredImage&&L(g.featuredImage)?g.featuredImage:d.defaultImage);var V={id:M,isChild:j,parent:W,position:J,tagCustomImg:U},E=null;s.allowedTags.includes(M)&&null!==U&&(null===E||z(V,E)<0)&&(E={id:M,isChild:j,parent:W,position:J,tagCustomImg:U},s.defaultImage=U)}}var G=1===Number(s.markReadCards)&&a.isRead()&&app.session.user?"read":"",K={};K.className="wrapImg"+(1===Number(s.showAuthor)?" After":"");var Q=function(t,a,s,e){if(void 0===s&&(s=!1),void 0===e&&(e=1),s&&L(a))return a;var r=app.forum.attribute("baseUrl")+"/assets/"+a;if(t){var i=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>|background(?:-image)?:\s*url\(['"]?(.*?)['"]?\)/i.exec(t.contentHtml());return"number"==typeof e&&e>0?i?i[1]||i[2]:a?r:null:"~"===e?i:null}}(a.firstPost(),s.defaultImage,p),X=Q?m("img",{src:Q,className:"previewCardImg",alt:a.title(),loading:"lazy"}):m("div",{className:"imgStub"}),Y=Math.min(null!=(t=a.lastPostNumber())?t:0,(a.lastReadPostNumber()||0)+1);return a.unreadCount()?app.translator.trans("walsgit_discussion_cards.forum.unreadReplies",{count:a.unreadCount()}):app.translator.trans("walsgit_discussion_cards.forum.replies",{count:a.replyCount()||"0"}),a.unreadCount()?a.unreadCount():a.replyCount(),m("div",{key:a.id(),"data-id":a.id(),"data-tag-id":w?h:null,className:"CardsListItem Card "+G+(a.isHidden()?" Hidden":"")},q().controls(a,this).toArray().length?m(H(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},q().controls(a,this).toArray()):"",m(x(),{href:app.route.discussion(a,Y),className:"cardLink"},m("div",K,(o||l)&&m("[",null,1!==Number(s.showViews)||isNaN(u)?"":m("div",{className:"imageLabel discussionViews"},C()("fas fa-eye",{className:"labelIcon"}),u)),X,1===Number(s.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},k()(a.user())),m("div",{className:"Date"},S()(a.createdAt()))):""),m("div",{className:"cardContentArea"},m("div",{className:"cardHeaderRow"},1===Number(s.showBadges)?T(a.badges().toArray()):"",m("div",{className:"cardTags"},B(a.tags())),m("div",{className:"cardTitle"},m("h2",{title:a.title(),className:"title"},1===Number(s.allowRepostLinks)&&v&&b?m("a",{href:b,onclick:function(t){return t.stopPropagation()}},(0,F.truncate)(a.title(),80)):(0,F.truncate)(a.title(),80))))),1===Number(s.previewText)&&a.firstPost()?m("div",{className:"previewPost"},m.trust(D(c&&1===Number(s.useBlogSummary)&&a.data.relationships.hasOwnProperty("blogMeta")&&""!==a.blogMeta().summary()?(0,F.truncate)(a.blogMeta().summary(),150):(0,F.truncate)(a.firstPost().contentPlain(),150)))):"",1===Number(s.showLastPostInfo)&&a.firstPost()?m("div",{className:"terminalPost"},m($(),{discussion:a,lastPost:a.lastPostNumber()})):""))},a}(N());const K=flarum.core.compat["common/utils/abbreviateNumber"];var Q=t.n(K),X=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a)},s.view=function(){var t,a=this.attrs.discussion,s={};for(var e in app.forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");s[r=r.replace(/^./,r.charAt(0).toLowerCase())]=app.forum.data.attributes[e]}var i="flarumite-simple-discussion-views"in flarum.extensions,o=a.data.attributes.hasOwnProperty("views"),n="michaelbelgium-discussion-views"in flarum.extensions,l=a.data.attributes.hasOwnProperty("viewCount"),u=i&&o?a.views():n&&l?a.viewCount():NaN,c=app.forum.data.attributes.hasOwnProperty("blogTags"),d={},p=a.data.relationships.hasOwnProperty("blogMeta"),g={};if(c&&(d.tags=app.forum.attribute("blogTags"),d.defaultImage=app.forum.attribute("blogDefaultImage"),p)){var f=a.store.data.blogMeta[a.data.relationships.blogMeta.data.id];L(f.attribute("featuredImage"))&&(g.featuredImage=f.attribute("featuredImage"))}var h="shebaoting-repost"in flarum.extensions,v=a.data.attributes.original_url||null;if(m.route.get().split("?")[0].startsWith("/t/")){var b,w=null==(b=m.route.get().split("/t/")[1])?void 0:b.split("?")[0],N=app.store.all("tags").find((function(t){return t.slug()===w})).data.id,y=app.store.all("tags").find((function(t){return t.id()===N})),I=y?JSON.parse(y.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},P=y?y.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var O in I.defaultImage=P,c&&1===Number(s.useBlogImages)&&d.tags.includes(N)&&(I.defaultImage=p&&g.featuredImage&&L(g.featuredImage)?g.featuredImage:d.defaultImage),I)s.hasOwnProperty(O)&&I[O]!==s[O]&&null!==I[O]&&(s[O]=I[O])}if("/"===m.route.get().split("?")[0]){var A=a.tags();for(var _ in A){var R=A[_].id(),M=A[_].isChild(),j=A[_].data.hasOwnProperty("relationships")&&A[_].parent()?A[_].parent().data.id:null,W=A[_].position(),J=A[_].attribute("walsgitDiscussionCardsTagDefaultImage");c&&1===Number(s.useBlogImages)&&d.tags.includes(R)&&(J=p&&g.featuredImage&&L(g.featuredImage)?g.featuredImage:d.defaultImage);var U={id:R,isChild:M,parent:j,position:W,tagCustomImg:J},V=null;s.allowedTags.includes(R)&&null!==J&&(null===V||z(U,V)<0)&&(V={id:R,isChild:M,parent:j,position:W,tagCustomImg:J},s.defaultImage=J)}}var E=1===Number(s.markReadCards)&&a.isRead()&&app.session.user?"read":"",G=Number(s.maxListImages)||3,K=a.tags(),X=K&&K.length>0?K[K.length-1]:null,Y=X?X.color():"#ddd",Z=function(t,a,s,e){void 0===s&&(s=!1),void 0===e&&(e=3);var r=[];if(s&&L(a)&&(r.push(a),1===e))return r;if(!t){if(a&&!s){var i=app.forum.attribute("baseUrl")+"/assets/"+a;r.push(i)}return r}for(var o,n=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>/gi,l=t.contentHtml(),u=s&&r.length>0?1:0;null!==(o=n.exec(l))&&u<e;){var c=o[1];c&&!r.includes(c)&&(r.push(c),u++)}if(0===r.length&&a){var m=app.forum.attribute("baseUrl")+"/assets/"+a;r.push(m)}return r}(a.firstPost(),s.defaultImage,p,G),tt=Z.length>0,at=Math.min(null!=(t=a.lastPostNumber())?t:0,(a.lastReadPostNumber()||0)+1),st=(a.unreadCount()?app.translator.trans("walsgit_discussion_cards.forum.unreadReplies",{count:a.unreadCount()}):app.translator.trans("walsgit_discussion_cards.forum.replies",{count:a.replyCount()||"0"}),a.unreadCount()?a.unreadCount()+"*":a.replyCount());return m("div",{key:a.id(),"data-id":a.id(),className:"CardsListItem List "+E+(a.isHidden()?" Hidden":""),style:"--tag-color: "+Y},q().controls(a,this).toArray().length?m(H(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},q().controls(a,this).toArray()):"",m(x(),{href:app.route.discussion(a,at),className:"cardLink"},m("div",{className:"listCardContent"},m("div",{className:"listCardHeader"},m("div",{className:"listHeaderRow"},1===Number(s.showBadges)&&T(a.badges().toArray()),m("div",{className:"cardTags"},B(a.tags())),m("div",{className:"cardTitle"},m("h2",{title:a.title(),className:"title"},1===Number(s.allowRepostLinks)&&h&&v?m("a",{href:v,onclick:function(t){return t.stopPropagation()}},(0,F.truncate)(a.title(),80)):(0,F.truncate)(a.title(),80)),"phone"!==app.screen()&&1===Number(s.showReplies)&&1===Number(s.showRepliesOnRight)?m("div",{className:"DiscussionListItem-count"},m("span",{"aria-hidden":"true"},Q()(st)),m("span",{className:"visually-hidden"},app.translator.trans("core.forum.discussion_list.unread_replies_a11y_label",{count:a.replyCount()}))):""))),1===Number(s.previewText)&&a.firstPost()?m("div",{className:"previewPost"},m.trust(D(c&&1===Number(s.useBlogSummary)&&a.data.relationships.hasOwnProperty("blogMeta")&&""!==a.blogMeta().summary()?(0,F.truncate)(a.blogMeta().summary(),300):(0,F.truncate)(a.firstPost().contentPlain(),300)))):"",tt&&m("div",{className:"listImagesRow"},Z.map((function(t,s){return m("img",{key:s,src:t,className:"listImageThumb",alt:a.title(),loading:"lazy"})}))),1===Number(s.showAuthor)&&m("div",{className:"listCardFooter"},m("div",{className:"listMetaInfo"},m("span",{className:"listAuthor"},k()(a.user())),1===Number(s.showReplies)&&m("span",{className:"listReplies"},C()("fas fa-comment",{className:"listIcon"}),m("span",null,st)),1===Number(s.showLastPostInfo)&&a.firstPost()&&m("span",{className:"listTerminalPost"},m($(),{discussion:a,lastPost:a.lastPostNumber()})),m("span",{className:"listDate"},S()(a.createdAt()))),(o||l)&&1===Number(s.showViews)&&!isNaN(u)&&m("div",{className:"listViews"},C()("fas fa-eye",{className:"listIcon"}),m("span",null,u))))))},a}(N());function Y(){var t=document.querySelectorAll(".CardsListItem.Card .cardLink"),a=document.querySelectorAll(".cardGrid .colSpan-2"),s=function(t,a){t&&(t.scrollWidth>a.clientWidth-30?t.classList.add("overflowing"):t.classList.remove("overflowing"))};t.forEach((function(t){var a=t.querySelector(".cardTags");s(a,t)})),a.forEach((function(t){var a=t.querySelector(".flexBox .cardTags");s(a,t)}))}const Z={"walsgit/discussion/cards/components/CardItem":G,"walsgit/discussion/cards/components/ListItem":X,"walsgit/discussion/cards/components/LastReplies":V,"walsgit/discussion/cards/utils/craftTags":B,"walsgit/discussion/cards/utils/craftBadges":T},tt=flarum.core;s().initializers.add("aoang-git-discussion-cards",(function(){(0,e.extend)(i().prototype,"oncreate",Y),(0,e.extend)(i().prototype,"onupdate",Y),(0,e.extend)(n().prototype,"requestParams",(function(t){s().current.matches(u())&&t.include.push(["firstPost","posts","posts.user"])})),(0,e.override)(i().prototype,"view",(function(t){var a={};for(var e in s().forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");r=r.replace(/^./,r.charAt(0).toLowerCase()),a[r]=s().forum.data.attributes[e]}if(a.allowedTags&&"string"==typeof a.allowedTags)try{a.allowedTags=JSON.parse(a.allowedTags)}catch(t){console.error("Failed to parse allowedTags:",t),a.allowedTags=[]}Array.isArray(a.allowedTags)||(a.allowedTags=[]);var i,o=this.attrs.state,n=o.getParams();if(o.isInitialLoading()||o.isLoadingNext()?i=m(d(),null):o.hasNext()&&(i=h().component({className:"Button",onclick:o.loadNext.bind(o)},s().translator.trans("core.forum.discussion_list.load_more_button"))),o.isEmpty()){var l=s().translator.trans("core.forum.discussion_list.empty_text");return m("div",{className:"DiscussionList"},m(g(),{text:l}))}var c=null;if(m.route.get().includes("/t/")&&n.tags){var p=s().store.all("tags").find((function(t){return t.slug()===n.tags}));if(p){c=String(p.data.id);var f=p.data.attributes.walsgitDiscussionCardsTagSettings;if(f)try{var v=JSON.parse(f);if(v&&"object"==typeof v)for(var b in v)a.hasOwnProperty(b)&&null!==v[b]&&void 0!==v[b]&&(a[b]=v[b])}catch(t){console.error("Failed to parse tag settings:",t)}}}return s().current.matches(u())&&(c&&a.allowedTags.length>0&&a.allowedTags.includes(c)||!n.tags&&1===Number(a.onIndexPage))?m("div",{className:"DiscussionList"+(o.isSearchResults()?" DiscussionList--searchResults":"")},m("div",{class:"DiscussionList-discussions flexCard"},o.getPages().map((function(t,s){return t.items.map((function(t,e){return e<Number(a.primaryCards)&&0===s?m(G,{discussion:t}):m(X,{discussion:t})}))}))),m("div",{className:"DiscussionList-loadMore"},i)):t()}))}),-1),Object.assign(tt.compat,Z)})(),module.exports={}})();
//# sourceMappingURL=forum.js.map